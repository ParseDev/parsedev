<!-- Chat Area -->
<div class="flex flex-col w-full min-h-screen bg-gray-100"> <!-- Updated classes here -->
    <!-- Chat Messages -->
    <div class="flex-1 p-4 overflow-auto mb-32" id="messages-container">
    <turbo-frame id="result_frame">
        <div class="mb-4">
            <div class="inline-block bg-green-100 rounded-tl-lg rounded-tr-lg rounded-br-lg px-4 py-2 text-green-800">
                Assistant: Hi, How can I help you today?
            </div>
        </div>
    </turbo-frame>
     
    </div>
    <!-- Input Bar -->
    <div class="fixed bottom-0 left-0 w-full border-t border-gray-300 p-4 bg-white"> <!-- Updated classes here -->
        <%= form_with url: prompts_path, remote: true, local: false, html: { id: 'generate-form', class: 'flex items-center', data: {turbo: true} } do |form| %>
        <!-- Dropdown -->
      <div class="relative overflow-hidden whitespace-nowrap text-overflow-ellipsis border-none mr-2 rounded-l-lg px-3 py-2 focus-within:outline-none focus-within:border-none focus-within:ring-0 ring-0">
        <%= form.select :datasource_id, current_user.company.datasources.map { |ds| [ds.name, ds.id] }, { prompt: 'Source' }, class: "w-full bg-white border-none focus-within:border-none focus-within:ring-0 ring-0", required: true %>
      </div>
        <!-- Input Text -->
      <%= form.text_area :input_field, class: "auto-grow-textarea border-none focus-ring-0 ring-0 h-10 flex-1 px-4 py-2 rounded-r-lg focus:outline-none focus:border-none", placeholder: "Type your message...", required: true, id: 'input-text-area', style: "max-height: 120px; overflow-y: auto;" %>


        <!-- Submit Button -->
        <%= button_tag(type: 'submit', class: "bg-blue-500 text-white px-4 py-2 rounded-r-lg ml-2 focus:outline-none focus:ring-2 focus:ring-blue-500", id: "generate-button") do %>
          <span id="send-text">Send</span>
          <span id="loader-container" style="display: none;">
            <%= render 'shared/loader' %>
          </span>
        <% end %>
      <% end %>

    </div>
</div>


<script>
  const form = document.getElementById('generate-form');
  const inputField = document.getElementById('input-text-area');
  const generateButton = document.getElementById('generate-button');

  form.addEventListener('submit', function(event) {
    let messageContent = inputField.value;
    var newMessage = document.createElement('div');
    newMessage.className = 'mb-4 mt-4';
    newMessage.innerHTML = `
        <div class="inline-block bg-blue-100 rounded-tl-lg rounded-tr-lg rounded-br-lg px-4 py-2 text-green-800">
            You: ${messageContent}
        </div>
    `;

      // Append the new HTML element to the messages-container
      document.getElementById('result_frame').appendChild(newMessage);


    // Disable the submit button
    generateButton.disabled = true;
  });

  // Listen for the "turbo:submit-end" event to re-enable the submit button
  form.addEventListener('turbo:submit-end', function(event) {
    // Re-enable the submit button
    generateButton.disabled = false;
    document.getElementById('send-text').style.display = 'inline';
    // Show the loader container
    document.getElementById('loader-container').style.display = 'none ';
    inputField.value = '';
  
  });

  
  
  document.getElementById('input-text-area').addEventListener('keydown', function(event) {
    // Check if the key code corresponds to the Enter key
    if (event.keyCode === 13) {
      // Prevent the default behavior of the Enter key (new line)
      event.preventDefault();
      // Submit the form
      var form = document.getElementById('generate-form');
      if(form.checkValidity()) {
        form.submit();
      } else {
        form.reportValidity();
      }

    }
  });

  document.getElementById('generate-form').addEventListener('submit', function(event) {
    // Hide the "Send" text
    document.getElementById('send-text').style.display = 'none';
    // Show the loader container
    document.getElementById('loader-container').style.display = 'inline';
  });
  

</script>